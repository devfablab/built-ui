{"version":3,"file":"BuiltUiRegistry.js","sources":["../../src/next/BuiltUiRegistry.tsx"],"sourcesContent":["import { ReactNode, useState } from 'react';\nimport { useServerInsertedHTML } from 'next/navigation';\nimport createCache from '@emotion/cache';\nimport { CacheProvider } from '@emotion/react';\nimport { BuiltUiThemeProvider } from '../theme/ThemeProvider';\nimport type { BuiltUiTheme } from '../theme/createTheme';\n\nexport type BuiltUiRegistryProps = {\n  theme: BuiltUiTheme;\n  children: ReactNode;\n};\n\ntype EmotionCacheEntry = {\n  cache: ReturnType<typeof createCache>;\n  flushInsertedStyleNameList: () => string[];\n};\n\nfunction createEmotionCacheEntry(cacheKey: string): EmotionCacheEntry {\n  const cache = createCache({ key: cacheKey });\n  cache.compat = true;\n\n  const insertedStyleNameSet = new Set<string>();\n  const originalInsertFunction = cache.insert;\n\n  cache.insert = (...argumentList) => {\n    const serializedStyle = argumentList[1];\n    if (serializedStyle && typeof serializedStyle.name === 'string') {\n      insertedStyleNameSet.add(serializedStyle.name);\n    }\n    return originalInsertFunction(...argumentList);\n  };\n\n  function flushInsertedStyleNameList() {\n    const insertedStyleNameList = Array.from(insertedStyleNameSet);\n    insertedStyleNameSet.clear();\n    return insertedStyleNameList;\n  }\n\n  return { cache, flushInsertedStyleNameList };\n}\n\nexport function BuiltUiRegistry(builtUiRegistryProps: BuiltUiRegistryProps) {\n  const { theme, children } = builtUiRegistryProps;\n\n  const cacheKey = 'built-ui';\n\n  const [emotionCacheEntry] = useState<EmotionCacheEntry>(() => createEmotionCacheEntry(cacheKey));\n\n  useServerInsertedHTML(() => {\n    const insertedStyleNameList = emotionCacheEntry.flushInsertedStyleNameList();\n    if (insertedStyleNameList.length === 0) return null;\n\n    const compiledStyles = insertedStyleNameList\n      .map((styleName) => emotionCacheEntry.cache.inserted[styleName])\n      .join('');\n\n    return (\n      <style\n        data-emotion={`${emotionCacheEntry.cache.key} ${insertedStyleNameList.join(' ')}`}\n        dangerouslySetInnerHTML={{ __html: compiledStyles }}\n      />\n    );\n  });\n\n  return (\n    <CacheProvider value={emotionCacheEntry.cache}>\n      <BuiltUiThemeProvider theme={theme}>{children}</BuiltUiThemeProvider>\n    </CacheProvider>\n  );\n}\n"],"names":["_jsx"],"mappings":";;;;;;;AAiBA,SAAS,uBAAuB,CAAC,QAAgB,EAAA;IAC/C,MAAM,KAAK,GAAG,WAAW,CAAC,EAAE,GAAG,EAAE,QAAQ,EAAE,CAAC;AAC5C,IAAA,KAAK,CAAC,MAAM,GAAG,IAAI;AAEnB,IAAA,MAAM,oBAAoB,GAAG,IAAI,GAAG,EAAU;AAC9C,IAAA,MAAM,sBAAsB,GAAG,KAAK,CAAC,MAAM;AAE3C,IAAA,KAAK,CAAC,MAAM,GAAG,CAAC,GAAG,YAAY,KAAI;AACjC,QAAA,MAAM,eAAe,GAAG,YAAY,CAAC,CAAC,CAAC;QACvC,IAAI,eAAe,IAAI,OAAO,eAAe,CAAC,IAAI,KAAK,QAAQ,EAAE;AAC/D,YAAA,oBAAoB,CAAC,GAAG,CAAC,eAAe,CAAC,IAAI,CAAC;QAChD;AACA,QAAA,OAAO,sBAAsB,CAAC,GAAG,YAAY,CAAC;AAChD,IAAA,CAAC;AAED,IAAA,SAAS,0BAA0B,GAAA;QACjC,MAAM,qBAAqB,GAAG,KAAK,CAAC,IAAI,CAAC,oBAAoB,CAAC;QAC9D,oBAAoB,CAAC,KAAK,EAAE;AAC5B,QAAA,OAAO,qBAAqB;IAC9B;AAEA,IAAA,OAAO,EAAE,KAAK,EAAE,0BAA0B,EAAE;AAC9C;AAEM,SAAU,eAAe,CAAC,oBAA0C,EAAA;AACxE,IAAA,MAAM,EAAE,KAAK,EAAE,QAAQ,EAAE,GAAG,oBAAoB;IAEhD,MAAM,QAAQ,GAAG,UAAU;AAE3B,IAAA,MAAM,CAAC,iBAAiB,CAAC,GAAG,QAAQ,CAAoB,MAAM,uBAAuB,CAAC,QAAQ,CAAC,CAAC;IAEhG,qBAAqB,CAAC,MAAK;AACzB,QAAA,MAAM,qBAAqB,GAAG,iBAAiB,CAAC,0BAA0B,EAAE;AAC5E,QAAA,IAAI,qBAAqB,CAAC,MAAM,KAAK,CAAC;AAAE,YAAA,OAAO,IAAI;QAEnD,MAAM,cAAc,GAAG;AACpB,aAAA,GAAG,CAAC,CAAC,SAAS,KAAK,iBAAiB,CAAC,KAAK,CAAC,QAAQ,CAAC,SAAS,CAAC;aAC9D,IAAI,CAAC,EAAE,CAAC;QAEX,QACEA,GAAA,CAAA,OAAA,EAAA,EAAA,cAAA,EACgB,CAAA,EAAG,iBAAiB,CAAC,KAAK,CAAC,GAAG,CAAA,CAAA,EAAI,qBAAqB,CAAC,IAAI,CAAC,GAAG,CAAC,CAAA,CAAE,EACjF,uBAAuB,EAAE,EAAE,MAAM,EAAE,cAAc,EAAE,EAAA,CACnD;AAEN,IAAA,CAAC,CAAC;IAEF,QACEA,IAAC,aAAa,EAAA,EAAC,KAAK,EAAE,iBAAiB,CAAC,KAAK,EAAA,QAAA,EAC3CA,IAAC,oBAAoB,EAAA,EAAC,KAAK,EAAE,KAAK,YAAG,QAAQ,EAAA,CAAwB,EAAA,CACvD;AAEpB;;;;"}